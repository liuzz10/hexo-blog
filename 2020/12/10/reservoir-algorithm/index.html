<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="John Doe">







<title>Reservoir Algorithm Explained (R, X and Y) | Hexo</title>



    <link rel="icon" href="/favicon.ico">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/frame.js"></script>
    






<script src='https://unpkg.com/valine@1.4.16/dist/Valine.min.js'></script>



  <meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            strawberrybfs&#39;s blog
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">Home</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">Archive</a>
              </li> 
                   
          
        </ul>
      </nav>
    </div>
  </div>
</div>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
                
                    <span class="post-tag">
                        <a href="/tags/algorithm/">
                            algorithm
                        </a>
                    </span>    
                
                    <span class="post-tag">
                        <a href="/tags/reservoir/">
                            reservoir
                        </a>
                    </span>    
                           
            
        </div>
        <div class="post-title">
            
            
                Reservoir Algorithm Explained (R, X and Y)
            
            
        </div>
        <span class="post-date">
            Dec 10, 2020
        </span>
    </div>
    <div class="post-img">
        
            <div class="h-line-primary"></div>
              
    </div>
</div>
    <div class="post-content">
    <h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p>The problem is to select a random sample of size n from a set of size N with following limitation:</p>
<ul>
<li>N is not given and we can’t generate any knowledge of N. Hence, it needs to be finished in one pass since N is not known.</li>
<li>Every element of N has the same probabilities to be selected (this is what “random sample” requires)</li>
</ul>
<p>If N is known, it’s relatively easy to do random sampling - we will just need to generate n random numbers from[1, N]. If N is not known, how do we make sure each element will be selected with the same probability?</p>
<p>This problem occurs frequently in the real world. For example, to select 1000 words from a super thick dictionary whose total number of words is not known. To select 300 samples from an ongoing data stream and we don’t know when the stream will end. Therefore, optimizing this problem will help with solving these problems.</p>
<h1 id="Reservoir-Algorithms"><a href="#Reservoir-Algorithms" class="headerlink" title="Reservoir Algorithms"></a>Reservoir Algorithms</h1><p>Reservoir algorithms are the solution to the above random sampling problem which needs to be finished in one pass. In other words, the time complexity is O(N). A “reservoir” is created to temporarily store candidates of samples that we should only keep track of. The size of the reservoir can be larger than n or equals to n.</p>
<p>Algorithm R, X, and Y all major players in reservoir algorithms. The following table is a brief comparison on their performance.</p>
<p><img src="table.jpg" alt="comparison table"></p>
<h1 id="Algorithm-R"><a href="#Algorithm-R" class="headerlink" title="Algorithm R"></a>Algorithm R</h1><p>Both the algorithm itself and proof are pretty elegant. I will first describe the algorithm and then give a proof about the correctness of it.</p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><p>When we are processing the kth number K:</p>
<ul>
<li>If Kn, which means that it’s one of the first n numbers,<ul>
<li>Add it to the reservoir directly.</li>
</ul>
</li>
<li>If K&gt;n, which means that it’s after the first n numbers, <ul>
<li>Generate a random number Rfrom[1, N].</li>
<li>If Rn , which means that there must be an corresponding Rth number in the reservoir of n numbers. Then we replace the Rth number with K.</li>
</ul>
</li>
<li>Process the next number with the same steps as above until reaching N.</li>
</ul>
<p>Time complexity. The time complexity is O(N) because we will need to scan every number for exactly one time and it takes constant time to process each number. </p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>Given an array [1, 2, 3, 4…], we are selecting a random sample of size 3. So in this example n = 2.</p>
<p>When we are processing 1 and 2, we can simply place numbers into the reservoir. If the streaming ends at 2, each number will have the same probability of 1 to be selected.</p>
<p>The reservoir is [1, 2] now. When we are processing 3, we will calculate a random number R from [1, 3]. If R is 1, we will replace 1 with 3 so that the reservoir will be [3, 2]. In this case, the probability of 3 being placed to the reservoir is 2/3. The probability of 1 or 2 being kept in the reservoir is 1 - 2/3 * 1/2 = 2/3 which is the same. </p>
<p>The reservoir is [3, 2] now. When we are processing 4, we will calculate a random number R from [1, 4]. If R is 2, we will replace 2 with 4 so that the reservoir will be [3, 4]. In this case, the probability of 4 being placed to the reservoir is 2/4. The probability of 3 or 2 being kept in the reservoir is 2/3 * (1 - 2/4 * 1/2) = 2/4 which is the same. </p>
<p>It will keep the same pattern when we are processing 5, 6, 7…. I will provide a proof as follows.</p>
<h2 id="Proof-by-induction"><a href="#Proof-by-induction" class="headerlink" title="Proof by induction"></a>Proof by induction</h2><p>Notation. when we are processing the ith number (to decide to include in the reservoir or not), we use the following notations to represent the event and probability:</p>
<ul>
<li><p>Xi: a random variable that represents the event to include the ith number in the reservoir or not.</p>
</li>
<li><p>Xi takes 2 values:</p>
<ul>
<li>Xi=1: the ith number is included in the reservoir</li>
<li>P(Xi=1): the probability of the ith number being included in the reservoir</li>
<li>Xi=0: the ith number is not included in the reservoir</li>
<li>P(Xi=0): the probability of the ith number not being included in the reservoir</li>
<li>P(Xi=1) + P(Xi=0)=1</li>
</ul>
</li>
</ul>
<p><strong>Proof</strong></p>
<ul>
<li><p>When i  n, the probability of the ith number being included in the reservoir is</p>
<p>  P(Xi=1) = 1</p>
<p>  or we can say</p>
<p>  P(X1=1) = P(X2=1) = ······ = P(Xi=1) = 1 </p>
</li>
<li><p>When i &gt; n, the probability of the ith number being included in the reservoir is</p>
<p>  P(Xi=1) = n/i</p>
<p>  or we can say</p>
<p>  P(X1=1) = P(X2=1) = ······ = P(Xi=1) = n/i</p>
<ul>
<li>We assume that it’s true and want to prove that the i+1th number also holds true. In other words, we are proving</li>
</ul>
<p>  P(X1=1) = P(X2=1) = ······ = P(Xi+1=1) =  n/(i+1)</p>
</li>
<li><p>When i=i+1, the probability of the (i+1)th number being selected to the reservoir is</p>
<p>  P(Xi+1=1) = n/(i+1)</p>
<p>  Part of the above equation is proved. Now we need to prove that the probability of the current numbers in reservoir being kept in the reservoir is n/(i+1) too since each number shall share the same probability to be selected to the reservoir.</p>
<ul>
<li><p>The probability of the current numbers in reservoir not being changed at this iteration is</p>
<p>  1 - P(Xi+1=1) * (1/n)</p>
<p>  1/n is the probability that a specific number in the reservoir is being selected under the condition that the (i+1)th number got the ticket to the reservoir.</p>
</li>
<li><p>The total probability of the current numbers in reservoir not being changed after all iterations is the above probability times P(Xi=1) </p>
<p>  P(X1=1) = P(X2=1) = ······<br>  = P(Xi=1) * (1 - P(Xi+1=1) * (1/n))<br>  = (n/i) * (1 - n/(i+1) * (1/n))<br>  = n/(i+1)</p>
</li>
<li><p>The algorithm is proved since it makes sure every number can be selected at the same probability. Elegant?</p>
</li>
</ul>
</li>
</ul>
<h1 id="Algorithm-X-and-Y"><a href="#Algorithm-X-and-Y" class="headerlink" title="Algorithm X and Y"></a>Algorithm X and Y</h1><h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>Algorithm R has to calculate random numbers from [1, n] for n-k times which can be optimized. The core of Algorithm R is the random number generator which makes some numbers gaining the “ticket” to go to the reservoir(when Xi=1) while some don’t(when Xi=0). If the generator “kicks out” some numbers, that means there are some numbers that wouldn’t get the “ticket” to get into the reservoir in the end, why don’t we skip these numbers at the very beginning?</p>
<p>If we can calculate how often a “lucky” number occurs, we can simply jump to this “lucky” number and skip all before it since we only need to place it in the reservoir. Algorithm X and Y does this.</p>
<h1 id="Common-Pattern"><a href="#Common-Pattern" class="headerlink" title="Common Pattern"></a>Common Pattern</h1><p>Algorithm X and Y optimize algorithm R in the times of calling the function that generates a random number. It “predicts” where the next lucky number is and is followed by following steps:</p>
<ul>
<li>Calculate how many numbers we shall skip: (n, i).</li>
<li>Skip (n, i) numbers.</li>
<li>Randomly select a number in the reservoir and replace it with the next number (the “lucky” number).</li>
<li>Repeat the above steps until the last number.</li>
</ul>
<p>How to calculate $\phi$(n, i)? We will need to get its cumulative distribution function F(s)=P(s), which is the probability to skip numbers less than or equals to s when we are on the ith number. That equals to the counterpart which is 1-P(&gt;s). What is P(&gt;s)? That is the probability if we skip more than s numbers so it’s the probability when all numbers from (i+1)th number to (i+1+s)th number are not selected. </p>

</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
                <div class="icon arrow-left"></div>
                <div class="post-link">
                    <a href="/2021/01/10/lc-11-container/">Prev</a>
                </div>
            
        </div>
        <div class="next-item">
            
                <div class="icon arrow-right"></div>
                <div class="post-link">
                  <a href="/2020/09/09/lc-134-gas-station/">Next</a>  
                </div>  
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

     

    
        <div id="disqus_thread"></div>
        <script>
            /**
            *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
            
            var disqus_config = function () {
                this.page.url = 'http://liuzz10.github.io/2020/12/10/reservoir-algorithm/';  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = '2020/12/10/reservoir-algorithm/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                this.language = 'en'
            };
            
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'joyblogs';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>   
     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
            
                © 2021 Zhuozhuo Liu | 
            
            
                Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/zoeingwingkei/frame/">Frame</a>
                
        </div>
    </div>
</div>

    </div>

  </body>
</html>
